name: T3-ETERNAL Validation

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM UTC

permissions:
  contents: read

jobs:
  # Job 1: VLAN Configuration Validation
  validate-vlan:
    runs-on: ubuntu-latest
    name: 'Validate VLAN Mappings'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check VLAN assignments
        run: |
          echo "ğŸ” Validating VLAN configuration..."
          
          # VLAN 10 must be Students/Chromebooks (10.10.0.0/23)
          if grep -r "VLAN 10.*Students" docs/; then
            echo "âœ… VLAN 10: Students/Chromebooks (correct)"
          else
            echo "âŒ VLAN 10: Mislabeled (must be Students)"
            exit 1
          fi
          
          # VLAN 20 must be Staff (10.20.0.0/24)
          if grep -r "VLAN 20.*Staff" docs/; then
            echo "âœ… VLAN 20: Staff (correct)"
          else
            echo "âŒ VLAN 20: Mislabeled"
            exit 1
          fi
          
          # VLAN 99 must be Management (10.99.0.0/28)
          if grep -r "VLAN 99.*Management" docs/; then
            echo "âœ… VLAN 99: Management (correct)"
          else
            echo "âŒ VLAN 99: Mislabeled"
            exit 1
          fi
          
          # VLAN 50 must be VoIP/Yealink (10.50.0.0/28)
          if grep -r "VLAN 50.*VoIP\|Yealink" docs/; then
            echo "âœ… VLAN 50: VoIP/Yealink (correct)"
          else
            echo "âŒ VLAN 50: Mislabeled"
            exit 1
          fi
          
          # VLAN 60 must be IoT/Verkada (10.60.0.0/28)
          if grep -r "VLAN 60.*IoT\|Verkada" docs/; then
            echo "âœ… VLAN 60: IoT/Verkada (correct)"
          else
            echo "âŒ VLAN 60: Mislabeled"
            exit 1
          fi
          
          echo "ğŸ† All VLAN mappings validated"

  # Job 2: mDNS/IGMP Configuration Validation
  validate-mdns:
    runs-on: ubuntu-latest
    name: 'Validate mDNS & IGMP'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check mDNS reflector configuration
        run: |
          echo "ğŸ” Validating mDNS reflector..."
          
          # Must mention mDNS reflector
          if grep -r "mDNS.*reflector\|reflector.*VLAN 10.*VLAN 20" docs/ scripts/; then
            echo "âœ… mDNS reflector: Configured"
          else
            echo "âŒ mDNS reflector: Not documented"
            exit 1
          fi
          
          # Must mention IGMP snooping
          if grep -r "IGMP.*snooping" docs/ scripts/; then
            echo "âœ… IGMP snooping: Documented"
          else
            echo "âŒ IGMP snooping: Not documented"
            exit 1
          fi
          
          # Band steering validation
          if grep -r "band steering\|-67 dBm\|5GHz preferred" docs/ scripts/; then
            echo "âœ… Band steering: Configured"
          else
            echo "âŒ Band steering: Not configured"
            exit 1
          fi
          
          echo "ğŸ† mDNS/IGMP validation passed"

  # Job 3: Secrets Management Scan
  validate-secrets:
    runs-on: ubuntu-latest
    name: 'Scan for Hardcoded Secrets'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for hardcoded credentials
        run: |
          echo "ğŸ” Scanning for hardcoded secrets..."
          
          # Fail if hardcoded passwords found
          if grep -r "password=" scripts/ config/ 2>/dev/null | grep -v "\.env\|example" || \
             grep -r "SIP_PASSWORD=" scripts/ config/ 2>/dev/null | grep -v "\.env" || \
             grep -r "VERKADA_API_KEY=" scripts/ config/ 2>/dev/null | grep -v "\.env"; then
            echo "âŒ HARDCODED CREDENTIALS DETECTED"
            exit 1
          fi
          
          # Check .env.example exists
          if [ -f ".env.example" ]; then
            echo "âœ… .env.example found (secrets template)"
          else
            echo "âŒ .env.example missing"
            exit 1
          fi
          
          # Check .gitignore includes .env
          if grep -q "\.env" .gitignore; then
            echo "âœ… .gitignore protects .env"
          else
            echo "âŒ .gitignore missing .env rule"
            exit 1
          fi
          
          echo "ğŸ† Secrets validation passed"

  # Job 4: PoE Budget Validation
  validate-poe:
    runs-on: ubuntu-latest
    name: 'Validate PoE Budget'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check PoE budget documentation
        run: |
          echo "ğŸ” Validating PoE budget..."
          
          # PoE budget must be documented: 459W current / 720W max
          if grep -r "459W\|720W" docs/ README.md; then
            echo "âœ… PoE budget documented (459W/720W = 64%)"
          else
            echo "âŒ PoE budget not documented correctly"
            exit 1
          fi
          
          # Must reference 85% threshold
          if grep -r "85%" docs/ scripts/ || grep -r "threshold" docs/ scripts/; then
            echo "âœ… PoE threshold documented"
          else
            echo "âš ï¸  PoE threshold not explicitly documented (optional)"
          fi
          
          # Must mention PoE+ for cameras
          if grep -r "PoE+\|PoE plus.*camera\|80W" docs/; then
            echo "âœ… PoE+ allocation for cameras documented"
          else
            echo "âŒ PoE+ camera allocation not documented"
            exit 1
          fi
          
          echo "ğŸ† PoE validation passed"

  # Job 5: Resale Accuracy Validation
  validate-resale:
    runs-on: ubuntu-latest
    name: 'Validate Resale Tracking'
    steps:
      - uses: actions/checkout@v4
      
      - name: Check resale tracker accuracy
        run: |
          echo "ğŸ” Validating resale tracking..."
          
          # Badge must show $1,430 REALIZED, not $2,500 claimed
          if grep -r "\$1,430.*[Rr]ealized\|Resale.*\$1,430" README.md; then
            echo "âœ… Resale badge accurate (\$1,430 realized)"
          else
            if grep -r "\$2,500" README.md; then
              echo "âŒ Resale badge inflated (shows \$2,500, only \$1,430 realized)"
              exit 1
            fi
          fi
          
          # Resale tracker CSV must exist
          if [ -f "inventory/resale-tracker.csv" ]; then
            echo "âœ… Resale tracker CSV exists"
            
            # Check for exact prices
            if grep -q "FortiGate.*150" inventory/resale-tracker.csv; then
              echo "âœ… FortiGate: \$150 realized"
            fi
            if grep -q "FortiSwitch.*250" inventory/resale-tracker.csv; then
              echo "âœ… FortiSwitch: \$250 realized"
            fi
            if grep -q "TRENDnet.*120" inventory/resale-tracker.csv; then
              echo "âœ… TRENDnet: \$120 realized"
            fi
          else
            echo "âŒ Resale tracker CSV missing"
            exit 1
          fi
          
          echo "ğŸ† Resale validation passed"

  # Aggregate: T3-ETERNAL Gate
  t3-eternal-gate:
    name: 'T3-ETERNAL: Trinity Verdict'
    needs: [validate-vlan, validate-mdns, validate-secrets, validate-poe, validate-resale]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Determine T3-ETERNAL Status
        run: |
          echo "ğŸ›ï¸  TRINITY MINISTRIES â€” FINAL VERDICT"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          SECRETS_STATUS="ETERNAL GREEN"
          WHISPERS_STATUS="ETERNAL GREEN"
          PERIMETER_STATUS="ETERNAL GREEN"
          
          if [ "${{ needs.validate-vlan.result }}" != "success" ]; then
            PERIMETER_STATUS="ETERNAL RED"
            echo "âŒ PERIMETER: VLAN validation failed"
          else
            echo "âœ… PERIMETER: VLAN validation passed"
          fi
          
          if [ "${{ needs.validate-mdns.result }}" != "success" ]; then
            WHISPERS_STATUS="ETERNAL RED"
            echo "âŒ WHISPERS: mDNS/IGMP validation failed"
          else
            echo "âœ… WHISPERS: mDNS/IGMP validation passed"
          fi
          
          if [ "${{ needs.validate-secrets.result }}" != "success" ]; then
            SECRETS_STATUS="ETERNAL RED"
            echo "âŒ SECRETS: Secrets scan failed"
          else
            echo "âœ… SECRETS: Secrets scan passed"
          fi
          
          if [ "${{ needs.validate-poe.result }}" != "success" ]; then
            PERIMETER_STATUS="ETERNAL RED"
            echo "âŒ PERIMETER: PoE validation failed"
          else
            echo "âœ… PERIMETER: PoE validation passed"
          fi
          
          if [ "${{ needs.validate-resale.result }}" != "success" ]; then
            PERIMETER_STATUS="ETERNAL RED"
            echo "âŒ PERIMETER: Resale accuracy failed"
          else
            echo "âœ… PERIMETER: Resale accuracy passed"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "SECRETS:   ${SECRETS_STATUS}"
          echo "WHISPERS:  ${WHISPERS_STATUS}"
          echo "PERIMETER: ${PERIMETER_STATUS}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ "$SECRETS_STATUS" = "ETERNAL RED" ] || \
             [ "$WHISPERS_STATUS" = "ETERNAL RED" ] || \
             [ "$PERIMETER_STATUS" = "ETERNAL RED" ]; then
            echo "ğŸ† T3-ETERNAL: RED â€” MERGE BLOCKED"
            exit 1
          else
            echo "ğŸ† T3-ETERNAL: ETERNAL GREEN â€” MERGE APPROVED"
            exit 0
          fi
