# Avahi mDNS/DNS-SD Daemon Configuration
# A+UP Charter School - VLAN-Selective mDNS Reflection
# 
# Purpose: Bridge mDNS between VLAN 10 (students) and VLAN 20 (staff/printers)
#          without affecting other VLANs (Guest, VoIP, Cameras, Management)
#
# Why not native UniFi mDNS?
#   - Native toggle affects ALL VLANs (cannot be selective)
#   - Would flood Guest VLAN 30 with printer broadcasts
#   - Would leak mDNS to Camera VLAN 60 (security issue)
#   - Avahi container provides precise VLAN targeting

[server]
# Hostname and domain
host-name=avahi-reflector
domain-name=local
use-ipv4=yes
use-ipv6=no

# Network interfaces
# ONLY reflect between br10 (VLAN 10 students) and br20 (VLAN 20 staff/printers)
allow-interfaces=br10,br20
deny-interfaces=br30,br50,br60,br99

# Publishing options
publish-addresses=yes
publish-hinfo=yes
publish-workstation=no
publish-domain=yes
publish-dns-servers=no
publish-resolv-conf-dns-servers=no

# D-Bus integration (disabled for container)
enable-dbus=no

# Rate limiting (prevent mDNS storms)
ratelimit-interval-usec=1000000
ratelimit-burst=1000

# Cache settings
cache-entries-max=4096

[wide-area]
enable-wide-area=no

[reflector]
# ENABLE REFLECTOR MODE
# This is the critical setting that bridges mDNS between br10 and br20
enable-reflector=yes

# Do NOT reflect IPv6 (not used in this deployment)
reflect-ipv=no

[rlimits]
# Resource limits for security
rlimit-core=0
rlimit-data=4194304
rlimit-fsize=0
rlimit-nofile=768
rlimit-stack=4194304
rlimit-nproc=3

# Configuration validation:
#   1. Verify br10 and br20 exist on UDM:
#      ip link show br10
#      ip link show br20
#   
#   2. Test mDNS query from VLAN 10:
#      avahi-browse -a -t -r
#   
#   3. Check reflector logs:
#      podman logs avahi-mdns-reflector | grep "Joining mDNS multicast group"
#      # Should show joins on both 10.10.x.x and 10.20.x.x
#
#   4. Verify printer discovery:
#      From Chromebook on VLAN 10, open Chrome → Print
#      Should see all 40+ printers from VLAN 20

# Expected mDNS services reflected:
#   - _ipp._tcp.local (Internet Printing Protocol)
#   - _airprint._tcp.local (Apple AirPrint)
#   - _printer._tcp.local (Generic printer discovery)
#   - _pdl-datastream._tcp.local (Page Description Language)
#
# Services NOT reflected (blocked by firewall):
#   - VLAN 30 → VLAN 20 (guests cannot discover printers)
#   - VLAN 10 → VLAN 60 (students cannot discover cameras)
#   - VLAN 50 → VLAN 20 (VoIP multicast does not leak to staff VLAN)

# Maintenance schedule:
#   Monthly: Review reflector logs for anomalies
#   Quarterly: Verify all 40+ printers discoverable from VLAN 10
#   Annually: Test container persistence across UDM firmware updates
#
# Backup/restore:
#   Container survives UDM reboots (restart: unless-stopped)
#   After firmware update, verify container auto-starts
#   If needed: ssh admin@10.99.0.1 && cd /mnt/data/avahi && podman-compose up -d

# References:
#   - Avahi docs: https://avahi.org/
#   - Docker image: https://hub.docker.com/r/flungo/avahi
#   - UniFi mDNS limitations: community.ui.com/questions/mDNS-per-VLAN
#   - ADR-010: docs/adr/adr-010-mdns-selective-reflection.md
